#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Markdown —Ä–∞–∑–º–µ—Ç–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ Perplexity
"""

from app.utils.announcement_processor import format_perplexity_response_with_quotes

def test_markdown_fix():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Markdown —Ä–∞–∑–º–µ—Ç–∫–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞"""
    
    # –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    real_example = """üöó –ù–µ —É–∫–∞–∑–∞–Ω–∞ –ù–µ —É–∫–∞–∑–∞–Ω–∞ 2025  
Custom ID: 160-415

üõ†Ô∏è **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏**  
- –î–≤–∏–≥–∞—Ç–µ–ª—å: 2.0 –ª, –±–µ–Ω–∑–∏–Ω, —Ç—É—Ä–±–æ, 245 –ª.—Å.  
- –ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á: –∞–≤—Ç–æ–º–∞—Ç  
- –ü—Ä–∏–≤–æ–¥: –ø–æ–ª–Ω—ã–π (4WD)  
- –ü—Ä–æ–±–µ–≥: 50 000 –∫–º  
- –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è: –∫–æ–º—Ñ–æ—Ä—Ç  
- –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞: 6.5‚Äì7.5 –ª/100 –∫–º (–¥–ª—è 2.0 –ª –±–µ–Ω–∑–∏–Ω–æ–≤—ã—Ö –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞)[1]  
- –ö–ª–∏—Ä–µ–Ω—Å: 180‚Äì200 –º–º (—Ç–∏–ø–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è SUV —ç—Ç–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞)  
- –û–±—ä–µ–º –±–∞–≥–∞–∂–Ω–∏–∫–∞: 500‚Äì550 –ª (—Ç–∏–ø–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è SUV 2.0 AWD)  

üõ°Ô∏è **–°–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–º–æ—â–∏**  
- ABS, ESP  
- –ú—É–ª—å—Ç–∏-—ç–π—Ä–±—ç–≥  
- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–ª–æ—Å—ã  
- –î–∞—Ç—á–∏–∫–∏ —Å–≤–µ—Ç–∞ –∏ –¥–æ–∂–¥—è  
- –ö–∞–º–µ—Ä–∞ –∑–∞–¥–Ω–µ–≥–æ –≤–∏–¥–∞, –ø–∞—Ä–∫—Ç—Ä–æ–Ω–∏–∫–∏  

üì± **–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞ –∏ –æ–ø—Ü–∏–∏**  
- –î–∏—Å–ø–ª–µ–π 10.25"  
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Apple CarPlay / Android Auto[1]  
- –ö—Ä—É–∏–∑-–∫–æ–Ω—Ç—Ä–æ–ª—å  
- –ö–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å  
- –ü–æ–¥–æ–≥—Ä–µ–≤ —Å–∏–¥–µ–Ω–∏–π  
- –î–∞—Ç—á–∏–∫–∏ –ø–∞—Ä–∫–æ–≤–∫–∏  

üìÑ **–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã**  
- –°–æ—Å—Ç–æ—è–Ω–∏–µ: —Ö–æ—Ä–æ—à–µ–µ  
- –î–æ–∫—É–º–µ–Ω—Ç—ã: –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç  

üí≥ **–£—Å–ª–æ–≤–∏—è –ø—Ä–æ–¥–∞–∂–∏**  
- –¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω  
- –î–æ—Å—Ç–∞–≤–∫–∞  
- –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç  
- –¶–µ–Ω–∞: 46 816 USD  

#–∞–≤—Ç–æ2025 #2–ª–∏—Ç—Ä–∞ #–ø–æ–ª–Ω—ã–π–ø—Ä–∏–≤–æ–¥ #–∞..."""

    print("üìã –¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø MARKDOWN –†–ê–ó–ú–ï–¢–ö–ò")
    print("=" * 60)
    
    print("\nüîπ –ò—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–∏–º–µ—Ä (—Å Markdown):")
    print(real_example[:500] + "..." if len(real_example) > 500 else real_example)
    
    print("\nüîπ –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:")
    formatted_response = format_perplexity_response_with_quotes(real_example)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–∫—Ü–∏—é —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
    lines = formatted_response.split('\n')
    tech_start = -1
    tech_end = -1
    
    for i, line in enumerate(lines):
        if '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏' in line.lower():
            tech_start = i
        elif tech_start != -1 and line.strip().startswith('üõ°'):
            tech_end = i
            break
    
    if tech_start != -1:
        if tech_end == -1:
            tech_end = len(lines)
        tech_section = '\n'.join(lines[tech_start:tech_end]).strip()
        print(tech_section)
    else:
        print("–°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    
    print("\nüîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
    if "<blockquote>" in formatted_response:
        print("‚úÖ HTML blockquote –¥–æ–±–∞–≤–ª–µ–Ω")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Markdown —É–±—Ä–∞–Ω
        blockquote_content = formatted_response[formatted_response.find('<blockquote>'):formatted_response.find('</blockquote>') + 12]
        if '**' not in blockquote_content and not any(line.strip().startswith('- ') for line in blockquote_content.split('\n')):
            print("‚úÖ Markdown —Ä–∞–∑–º–µ—Ç–∫–∞ –æ—á–∏—â–µ–Ω–∞")
        else:
            print("‚ùå Markdown —Ä–∞–∑–º–µ—Ç–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å")
            
    else:
        print("‚ùå HTML blockquote –Ω–µ –Ω–∞–π–¥–µ–Ω")

if __name__ == "__main__":
    test_markdown_fix() 