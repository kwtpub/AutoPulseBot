# Storage API Module

–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —á–µ—Ä–µ–∑ HTTP API.

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –≠–¢–û–¢ –ú–û–î–£–õ–¨ –ù–ï –¢–†–û–ì–ê–ï–ú!

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–¥–∞ –±–æ—Ç–∞. 
**–ù–ï –ò–ó–ú–ï–ù–Ø–ô–¢–ï –ö–û–î –í –≠–¢–û–ô –ü–ê–ü–ö–ï** –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
app/storage_api/
‚îú‚îÄ‚îÄ __init__.py              # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ database_client.py       # –û—Å–Ω–æ–≤–Ω–æ–π HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
‚îú‚îÄ‚îÄ legacy_wrapper.py        # –û–±–µ—Ä—Ç–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
‚îú‚îÄ‚îÄ test_storage.py         # –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
‚îî‚îÄ‚îÄ README.md               # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. DatabaseClient (database_client.py)

–û—Å–Ω–æ–≤–Ω–æ–π HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Node.js API –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

- `health_check()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã API
- `save_car(car_data)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
- `check_duplicate(message_id, channel)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- `get_car(custom_id)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ ID
- `get_all_cars(limit, offset)` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π

### 2. Legacy Wrapper (legacy_wrapper.py)

–û–±–µ—Ä—Ç–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º:

- `send_car_to_node(car_dict)` - –∑–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- `check_duplicate_car(msg_id, channel)` - –∑–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
- `test_database_connection()` - —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### 3. CarData (database_client.py)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è:

```python
@dataclass
class CarData:
    custom_id: str
    source_message_id: int
    source_channel_name: str
    brand: Optional[str] = None
    model: Optional[str] = None
    year: Optional[int] = None
    price: Optional[float] = None
    description: Optional[str] = None
    photos: Optional[List[str]] = None
    status: str = 'available'
    target_channel_message_id: Optional[int] = None
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```python
from app.storage_api.legacy_wrapper import send_car_to_node, check_duplicate_car

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
car_data = {
    'custom_id': '12345678',
    'source_message_id': 1001,
    'source_channel_name': '@source_channel',
    'brand': 'Toyota',
    'model': 'Camry',
    'year': 2020,
    'price': 1500000.0,
    'description': '–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ',
    'photos': ['https://cloudinary.com/image1.jpg'],
    'status': 'available'
}

result = send_car_to_node(car_data)
print(result)  # {'message': 'Car saved successfully'}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞
duplicate = check_duplicate_car(1001, '@source_channel')
if duplicate:
    print(f"–ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: {duplicate['custom_id']}")
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å–ø–æ—Å–æ–±

```python
from app.storage_api.database_client import get_client, CarData

client = get_client()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã API
if client.health_check():
    print("API —Ä–∞–±–æ—Ç–∞–µ—Ç")

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
car = CarData(
    custom_id='12345678',
    source_message_id=1001,
    source_channel_name='@source_channel',
    brand='Toyota',
    model='Camry'
)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
result = client.save_car(car)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:

```bash
cd app/storage_api
python test_storage.py
```

–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
- ‚úÖ Health check
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

- **API URL**: `http://localhost:3001` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **–¢–∞–π–º–∞—É—Ç—ã**: 5-10 —Å–µ–∫—É–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å –≤–µ–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```
üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è: 12345678
‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: 12345678
üîç –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: 87654321
‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞: 500
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ú–æ–¥—É–ª—å gracefully –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:

- **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏**: –í–æ–∑–≤—Ä–∞—Ç `None` –∏–ª–∏ `False`
- **–¢–∞–π–º–∞—É—Ç—ã**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
- **–û—à–∏–±–∫–∏ API**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- `requests` - –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `python-dotenv` - –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

Node.js API –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ `localhost:3001` —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏:

- `GET /api/health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
- `POST /api/cars` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
- `GET /api/cars/check-duplicate/{msg_id}/{channel}` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞
- `GET /api/cars/{custom_id}` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
- `GET /api/cars` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π

## –ù–æ–≤—ã–π Data Formatter (data_formatter.py)

–ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

### `extract_car_details(text)`
–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.

### `format_car_data_for_storage(...)` 
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ.

### `save_car_with_formatting(...)` ‚≠ê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø

```python
from app.storage_api.legacy_wrapper import save_car_with_formatting

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
result = save_car_with_formatting(
    custom_id='12345678',
    source_message_id=1001,
    source_channel_name='@channel',
    description='Toyota Camry [2020] —Ü–µ–Ω–∞ 1500000‚ÇΩ',
    cloudinary_urls=['https://cloudinary.com/1.jpg'],
    target_msg_id=2001
)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á–µ—Ç: brand='Toyota', model='Camry', year=2020, price=1500000.0
```

## –ú–∏–≥—Ä–∞—Ü–∏—è

–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –∑–∞–º–µ–Ω–∏—Ç–µ –∏–º–ø–æ—Ä—Ç—ã:

```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥
from app.utils.send_to_node import send_car_to_node
from app.utils.channel_parser import check_duplicate_car

# –ù–æ–≤—ã–π –∫–æ–¥  
from app.storage_api.legacy_wrapper import send_car_to_node, check_duplicate_car

# –ï—â–µ –ª—É—á—à–µ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
from app.storage_api.legacy_wrapper import save_car_with_formatting
```

–§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ä–∞–Ω—å—à–µ! 